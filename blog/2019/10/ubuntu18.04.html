<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>安装、配置Ubuntu 18.04、KVM和群晖</title>
<meta name="author" content="Albert Zhou">
<meta name="referrer" content="no-referrer">
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=0.5">
<link href= "/main.css" rel="stylesheet" type="text/css" />
<link rel="icon" href="/favicon.ico"></head>
<body>
<div id="preamble" class="status"></div>
<div id="content">
  <div class="post-date">2019年09月14日</div>
  <h1>安装、配置Ubuntu 18.04、KVM和群晖</h1>
<p>
<span class="timestamp-wrapper"><span class="timestamp">[2019-09-14 Sat 00:56]</span></span>
</p>


<h2>安装Ubuntu 18.04</h2>

<p>
安装过程很简单。插上u盘，启动后需要等几分钟才能进系统，E6400的usb 2.0的速度太慢了。一路Next。因为只有一块SSD，就不需要LVM，也可以不划/boot和/swap分区，让Ubuntu自动创建。如果需要划/boot分区，至少分512MB。原来/boot分了128MB，在Ubuntu升级了几次内核后，/boot分区 100%了，又没有用LVM，扩都不好扩。
</p>

<p>
现在把一块256G的msata SSD挂到光驱位了，把硬盘位留给机械硬盘。
</p>

<p>
用20.04的u盘在T430上启动不了。只有18.04可以。
</p>


<h2>安装常用软件</h2>



<h3>更新源</h3>

<div class="org-src-container">
<pre class="src src-sh">apt-get update
</pre>
</div>

<h3>安装ssh</h3>

<div class="org-src-container">
<pre class="src src-sh">sudo apt-get install ssh
</pre>
</div>


<h3>安装screen</h3>

<p>
窗口管理器，用惯了screen，有空再试试tmux。
</p>
<div class="org-src-container">
<pre class="src src-sh">apt-get install screen
</pre>
</div>


<h3>安装vim</h3>

<p>
装个完整的vim会比较顺手。
</p>
<div class="org-src-container">
<pre class="src src-sh">apt-get install vim
</pre>
</div>


<h3>安装kvm</h3>

<p>
vlan是给单臂路由的场景用的。
</p>
<div class="org-src-container">
<pre class="src src-sh">apt-get install qemu-kvm qemu-system libvirt-bin virt-manager bridge-utils vlan

[2020-08-29 &#21608;&#20845; 21:52:13] ubuntu 20.04 &#35013;libvirt-bin&#25253;&#38169;
apt-get install qemu-kvm qemu-system virt-manager bridge-utils vlan
</pre>
</div>


<h3>安装温度监控 <span class="timestamp-wrapper"><span class="timestamp">[2019-09-14 Sat 02:37]</span></span></h3>

<p>
E6400和T430都可以，E6400上显示的多些。
</p>
<div class="org-src-container">
<pre class="src src-sh">sudo apt-get install lm-sensors

<span style="color: #B0BED8;"># </span><span style="color: #B0BED8;">&#25191;&#34892;&#21629;&#20196;sensors-detect&#65292;&#36827;&#34892;&#31616;&#21333;&#37197;&#32622;&#65292;&#27492;&#21629;&#20196;&#25191;&#34892;&#21518;&#20250;&#20986;&#29616;&#19968;&#31995;&#21015;&#36873;&#39033;&#65292;&#19968;&#30452;yes&#21363;&#21487;&#65307;</span>
<span style="color: #B0BED8;"># </span><span style="color: #B0BED8;">&#23433;&#35013;&#23436;&#21518;</span>
sensors
</pre>
</div>


<h3>安装htop</h3>

<p>
颜色好看，可以看进程中的线程。
</p>
<div class="org-src-container">
<pre class="src src-sh">apt-get install htop
</pre>
</div>


<h3>编译、安装tsar，记录性能数据</h3>

<p>
本来想让ssd能少写点数据，但是没有tsar记录系统资源使用情况有点不方便。只能装了。
</p>


<h3>编译、安装emacs 27.0.50</h3>

<p>
系统稳定以后，有空再装了。
</p>

<h2>系统常用配置</h2>



<h3>笔记本合盖不休眠</h3>

<p>
机器是7*24小时开机的，在合盖后机器不休眠。
<a href="https://blog.csdn.net/ezhchai/article/details/80548130">https://blog.csdn.net/ezhchai/article/details/80548130</a>
</p>

<div class="org-src-container">
<pre class="src src-sh">vim /etc/systemd/logind.conf
<span style="color: #B0BED8;">#</span><span style="color: #B0BED8;">HandleLidSwitch=suspend</span>
&#25913;&#25104;&#65306;
<span style="color: #4eee94;">HandleLidSwitch</span>=ignore
</pre>
</div>

<p>
重启服务
</p>
<div class="org-src-container">
<pre class="src src-sh">systemctl restart system-logind
</pre>
</div>


<h3>修改hostname</h3>

<p>
hostname如果在安装的时候没配对，可以修改 <b>/etc/hostname</b> 。
</p>


<h3>修改网卡名为eth0/wlan0</h3>

<p>
默认的名字是按总线命名的，看着不习惯，改回原来的方式。
</p>
<div class="org-src-container">
<pre class="src src-sh">root@E6400:~# vim /etc/default/grub
<span style="color: #4eee94;">GRUB_CMDLINE_LINUX</span>=<span style="color: #deb887;">"net.ifnames=0 biosdevname=0"</span>

root@E6400:~# update-grub
</pre>
</div>


<h3>修改.profile，让时间戳和提示符更好看</h3>

<ol>
<li>改为英文，看中文的时间戳不习惯。</li>
<li>提示符也改成带颜色的。</li>
</ol>
<div class="org-src-container">
<pre class="src src-sh">vim ~/.profile
<span style="color: #f08080;">set</span> -o vi
<span style="color: #f08080;">export</span> <span style="color: #4eee94;">LC_ALL</span>=en_US.UTF-8
<span style="color: #f08080;">export</span> <span style="color: #4eee94;">PS1</span>=<span style="color: #deb887;">'\n\e[1;37m[\e[m\e[1;32m\u\e[m\e[1;33m@\e[m\e[1;35m\H\e[m \e[4m`pwd`\e[m\e[1;37m]\e[m\e[1;36m\e[m\n\$'</span>
</pre>
</div>


<h3>关闭不用的服务</h3>

<div class="org-src-container">
<pre class="src src-sh">systemctl disable cups
</pre>
</div>


<h2>安装驱动</h2>



<h3>安装bcm43224无线网卡驱动</h3>

<ul>
<li>问题
<ol>
<li>使用不同的驱动，发现有些驱动会导致ping的延时高</li>
</ol></li>
</ul>

<p>
唉，忘记到底是怎么把无线网卡驱动装上去的了。
</p>

<p>
参考： <a href="https://help.ubuntu.com/community/WifiDocs/Driver/bcm43xx#brcmfmac_driver_.28Open-source.29">https://help.ubuntu.com/community/WifiDocs/Driver/bcm43xx#brcmfmac_driver_.28Open-source.29</a>
</p>

<p>
Installing STA drivers
</p>
<div class="org-src-container">
<pre class="src src-sh">root@E6400:~# apt-get --reinstall install bcmwl-kernel-source

root@E6400:~# apt-get --reinstall install broadcom-sta-common
</pre>
</div>

<p>
<span class="timestamp-wrapper"><span class="timestamp">[2019-09-14 Sat 02:31]</span></span>
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #B0BED8;"># </span><span style="color: #B0BED8;">Switching between drivers</span>
<span style="color: #B0BED8;"># </span><span style="color: #B0BED8;">If you card is supported by more than one driver then use the modprobe command to test the drivers. First unload all conflicting drivers (this includes removing the driver you're trying to install):</span>
sudo modprobe -r b43 bcma
sudo modprobe -r brcmsmac bcma
sudo modprobe -r wl

<span style="color: #B0BED8;"># </span><span style="color: #B0BED8;">To load a specific driver use one of the following commands:</span>
sudo modprobe b43
sudo modprobe brcmsmac
sudo modprobe wl
</pre>
</div>

<p>
这是用了b43(不知道是什么)和brcmsmac(开源驱动，支持bcm43224芯片)的。
</p>
<div class="org-src-container">
<pre class="src src-sh">root@E6400:~# lsmod|grep wl
wl                   6447104  0
cfg80211              675840  4 wl,b43,mac80211,brcmsmac
</pre>
</div>

<p>
<span class="timestamp-wrapper"><span class="timestamp">[2019-10-31 Thu 10:44] </span></span> 安装b43驱动
</p>
<div class="org-src-container">
<pre class="src src-sh">sudo apt-get install firmware-b43-installer
</pre>
</div>

<h2>网卡直通 <span class="timestamp-wrapper"><span class="timestamp">[2020-08-15 Sat 21:29]</span></span></h2>

<p>
<span class="timestamp-wrapper"><span class="timestamp">[2021-09-07 Tue 00:18] </span></span> updated: 使用 <code>macvtap</code> 方式，不再用直通方式，宿主机只有一个千兆电口。
</p>
<div class="org-src-container">
<pre class="src src-sh">[albert@T430 /home/albert]
$<span style="color: #4eee94;">lspci</span> -nn|grep -i network
00:19.0 Ethernet controller [0200]: Intel Corporation 82579LM Gigabit Network Connection (Lewisville) [8086:1502] (rev 04)
03:00.0 Network controller [0280]: Intel Corporation Centrino Ultimate-N 6300 [8086:4238] (rev 35)
</pre>
</div>

<h2>dsm5.2 <span class="timestamp-wrapper"><span class="timestamp">[2019-09-14 Sat 16:03]</span></span></h2>

<p>
dsm5.2的功能正常，可以网卡直通。就是版本稍微有点低。
</p>

<p>
创建vm：
</p>
<div class="org-src-container">
<pre class="src src-sh">virt-install --name dsm5.2 --memory 2000 --vcpus <span style="color: #4eee94;">sockets</span>=1,<span style="color: #4eee94;">cores</span>=1,<span style="color: #4eee94;">threads</span>=1 --disk <span style="color: #4eee94;">device</span>=cdrom,<span style="color: #4eee94;">path</span>=/home/albert/dsm/dsm5.2/XPEnoboot_DS3615xs_5.2-5967.1.iso  --network <span style="color: #4eee94;">bridge</span>=br0,<span style="color: #4eee94;">model</span>=e1000e --noautoconsole --accelerate --hvm --graphics vnc,<span style="color: #4eee94;">listen</span>=0.0.0.0,<span style="color: #4eee94;">port</span>=20008 --video vga --input tablet,<span style="color: #4eee94;">bus</span>=usb --cpu host-passthrough
</pre>
</div>

<p>
<span class="timestamp-wrapper"><span class="timestamp">[2020-08-15 Sat 22:28]</span></span>
T430 dsm6.2
</p>

<div class="org-src-container">
<pre class="src src-sh">virt-install --name dsm6.2 --memory 4000 --vcpus <span style="color: #4eee94;">sockets</span>=1,<span style="color: #4eee94;">cores</span>=1,<span style="color: #4eee94;">threads</span>=1 --disk <span style="color: #4eee94;">device</span>=cdrom,<span style="color: #4eee94;">path</span>=/home/albert/dsm6.2/synoboot_dsm_ds918_24922_pve.img --network <span style="color: #4eee94;">bridge</span>=br0,<span style="color: #4eee94;">model</span>=e1000e --noautoconsole --accelerate --hvm --graphics vnc,<span style="color: #4eee94;">listen</span>=0.0.0.0,<span style="color: #4eee94;">port</span>=20008 --video vga --input tablet,<span style="color: #4eee94;">bus</span>=usb --cpu host-passthrough
</pre>
</div>


<h3>硬盘优化</h3>

<p>
参考pve的 <a href="https://pve.proxmox.com/wiki/Pci_passthrough">https://pve.proxmox.com/wiki/Pci_passthrough</a>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #B0BED8;"># </span><span style="color: #B0BED8;">&#22686;&#21152;iommu&#30340;&#25903;&#25345;</span>
$<span style="color: #4eee94;">vim</span> /etc/default/grub
<span style="color: #4eee94;">GRUB_CMDLINE_LINUX_DEFAULT</span>=<span style="color: #deb887;">"quiet splash intel_iommu=on"</span>

<span style="color: #B0BED8;"># </span><span style="color: #B0BED8;">&#26356;&#26032;&#20869;&#26680;&#21442;&#25968;&#65292;&#37325;&#21551;&#29983;&#25928;</span>
$<span style="color: #4eee94;">update</span>-grub

<span style="color: #B0BED8;"># </span><span style="color: #B0BED8;">&#26816;&#26597;iommu&#30340;&#21442;&#25968;&#26159;&#21542;&#29983;&#25928;</span>
root@E6400:~# dmesg|grep IOMM
[    0.091713] DMAR: IOMMU enabled
[    0.467216] DMAR: Disabling IOMMU for graphics on this chipset
</pre>
</div>

<p>
使用vfio。
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #f08080;">echo</span> <span style="color: #deb887;">"options vfio_iommu_type1 allow_unsafe_interrupts=1"</span> &gt; /etc/modprobe.d/iommu_unsafe_interrupts.conf
</pre>
</div>

<p>
<a href="https://forums.unraid.net/topic/46634-passthrough-hard-drive-to-vm/">https://forums.unraid.net/topic/46634-passthrough-hard-drive-to-vm/</a>
</p>

<p>
<a href="https://turlucode.com/qemu-disk-io-performance-comparison-native-or-threads-windows-10-version/#1528572626148-2b30f3e4-f00f">https://turlucode.com/qemu-disk-io-performance-comparison-native-or-threads-windows-10-version/#1528572626148-2b30f3e4-f00f</a> kvm的各种模式的解释和对比
</p>


<h4>Centos6配置KVM使用virtio-scsi（multi-queues）</h4>

<p>
<a href="https://blog.csdn.net/bobpen/article/details/41515119">https://blog.csdn.net/bobpen/article/details/41515119</a> Centos6下Virtio-SCSI(multi-queues)/Virtio-SCSI/Virtio-blk性能对比 - 多队列的性能也一般
</p>

<p>
<a href="https://www.jianshu.com/p/0288235387c7">https://www.jianshu.com/p/0288235387c7</a> 深入浅出KVM（三） 丨 I/O 全虚拟化和准虚拟化
</p>

<p>
<span class="timestamp-wrapper"><span class="timestamp">[2019-09-15 Sun 16:45] </span></span> 只有一个vcpu，设不设都一样
添加driver queues字段至xml文件中，driver queues等于vcpu队列数
</p>

<pre class="example" id="orgca10b2a">
&lt;disk type='block' device='disk'&gt;
  &lt;driver name='qemu' type='raw' cache='none' io='threads'/&gt;
  &lt;source dev='/dev/disk/by-id/ata-ST320LT007-9ZV142_W0Q5K6ZN'/&gt;
  &lt;backingStore/&gt;
  &lt;target dev='sdb' bus='scsi'/&gt;
  &lt;alias name='scsi0-0-0-1'/&gt;
  &lt;address type='drive' controller='0' bus='0' target='0' unit='1'/&gt;
&lt;/disk&gt;

&lt;/controller&gt;
  &lt;controller type='scsi' index='0' model='virtio-scsi'&gt;
  &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x08' function='0x0'/&gt;
  &lt;dirver queues='8' /&gt;
&lt;/controller&gt;
</pre>

<p>
<a href="https://blog.csdn.net/bobpen/article/details/41515263">https://blog.csdn.net/bobpen/article/details/41515263</a>
</p>


<h3>内存优化 - 使用HugePage</h3>

<p>
给虚机分配2G内存，需要1000个2MB的页。
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #B0BED8;"># </span><span style="color: #B0BED8;">&#25351;&#23450;&#22823;&#39029;&#38656;&#35201;&#30340;&#20869;&#23384;&#39029;&#38754;&#25968;&#65292;&#27704;&#20037;&#29983;&#25928;&#65292;1024*2MB=2048MB&#20869;&#23384;&#20316;&#20026;hugepages</span>
sysctl -w vm.nr_hugepages=1024

<span style="color: #B0BED8;"># </span><span style="color: #B0BED8;">&#25110;&#32773;</span>
<span style="color: #B0BED8;">#</span><span style="color: #B0BED8;">vim /etc/sysctl.conf</span>
vm.nr_hugepages=1024

<span style="color: #B0BED8;"># </span><span style="color: #B0BED8;">&#35753;&#37197;&#32622;&#29983;&#25928;</span>
sysctl -p
</pre>
</div>

<p>
检查HugePage是否ok：
</p>
<div class="org-src-container">
<pre class="src src-sh">[root@E6400 /root]
<span style="color: #B0BED8;">#</span><span style="color: #B0BED8;">cat /proc/meminfo |grep Huge</span>
AnonHugePages:         0 kB
ShmemHugePages:        0 kB
HugePages_Total:    1024
HugePages_Free:     1024
HugePages_Rsvd:        0
HugePages_Surp:        0
Hugepagesize:       2048 kB
Hugetlb:         2097152 kB
</pre>
</div>


<h4>KSM优化</h4>

<p>
只起了一个虚机，不需要os来压缩vm的内存。可以关掉ksm。
</p>

<p>
为什么没地方停ksm呢？
</p>

<p>
<a href="https://serverfault.com/questions/470093/why-kernel-shared-memory-is-0-on-ubuntu-12-04">https://serverfault.com/questions/470093/why-kernel-shared-memory-is-0-on-ubuntu-12-04</a>#
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #f08080;">echo</span> 2 &gt; /sys/kernel/mm/ksm/run
</pre>
</div>

<pre class="example" id="org48bd936">
How to use the Kernel Samepage Merging feature

run         - set 0 to stop ksmd from running but keep merged pages,
              set 1 to run ksmd e.g. "echo 1 &gt; /sys/kernel/mm/ksm/run",
              set 2 to stop ksmd and unmerge all pages currently merged,
                    but leave mergeable areas registered for next run
              Default: 0 (must be changed to 1 to activate KSM,
                          except if CONFIG_SYSFS is disabled)
</pre>

<p>
只能把扫描时间加长了？提到的配置文件找不到 <a href="https://forum.proxmox.com/threads/ksm-is-using-about-30-of-cpu-time.3857/page-2">https://forum.proxmox.com/threads/ksm-is-using-about-30-of-cpu-time.3857/page-2</a>
</p>


<h3>usb passthrough <span class="timestamp-wrapper"><span class="timestamp">[2019-09-15 Sun 21:47]</span></span></h3>

<p>
<span class="timestamp-wrapper"><span class="timestamp">[2019-09-15 Sun 22:42] </span></span> 为什么group 5的4个设备都要删除，kvm才不会报错？
</p>

<p>
<a href="https://forums.unraid.net/topic/35112-guide-passthrough-entire-pci-usb-controller/">https://forums.unraid.net/topic/35112-guide-passthrough-entire-pci-usb-controller/</a>
</p>

<p>
确定usb设备的总线位置，可以插个u盘上去后，看u盘对应的总线号。
</p>
<div class="org-src-container">
<pre class="src src-sh">root@E6400:~# lsusb
Bus 002 Device 005: ID 0781:5567 SanDisk Corp. Cruzer Blade - &#24038;&#19979;esata
Bus 002 Device 003: ID 0ed1:6981 WinMaxGroup - &#24038;&#19978;
Bus 002 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub - &#21491;&#19978;
Bus 008 Device 001: ID 1d6b:0001 Linux Foundation 1.1 root hub
Bus 007 Device 001: ID 1d6b:0001 Linux Foundation 1.1 root hub
Bus 006 Device 002: ID 046d:c52b Logitech, Inc. Unifying Receiver - &#21491;&#19979;
Bus 006 Device 001: ID 1d6b:0001 Linux Foundation 1.1 root hub
Bus 001 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub
Bus 005 Device 002: ID 0a5c:5801 Broadcom Corp. BCM5880 Secure Applications Processor with fingerprint swipe sensor
Bus 005 Device 001: ID 1d6b:0001 Linux Foundation 1.1 root hub
Bus 004 Device 001: ID 1d6b:0001 Linux Foundation 1.1 root hub
Bus 003 Device 001: ID 1d6b:0001 Linux Foundation 1.1 root hub

root@E6400:~# readlink /sys/bus/usb/devices/usb2
../../../devices/pci0000:00/0000:00:1d.7/usb2
</pre>
</div>

<ol>
<li><p>
将iommu_group下的设备unbind，将设备unbind之后，目录下面的driver目录会被删除
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #f08080;">echo</span> <span style="color: #deb887;">"0000:00:1d.7"</span> &gt;&gt;/sys/bus/pci/devices/0000<span style="color: #deb887;">\:</span>00<span style="color: #deb887;">\:</span>1d.7/driver/unbind

<span style="color: #f08080;">echo</span> <span style="color: #deb887;">"0000:00:1d.0"</span> &gt;&gt;/sys/bus/pci/devices/0000<span style="color: #deb887;">\:</span>00<span style="color: #deb887;">\:</span>1d.0/driver/unbind
<span style="color: #f08080;">echo</span> <span style="color: #deb887;">"0000:00:1d.1"</span> &gt;&gt;/sys/bus/pci/devices/0000<span style="color: #deb887;">\:</span>00<span style="color: #deb887;">\:</span>1d.1/driver/unbind
<span style="color: #f08080;">echo</span> <span style="color: #deb887;">"0000:00:1d.2"</span> &gt;&gt;/sys/bus/pci/devices/0000<span style="color: #deb887;">\:</span>00<span style="color: #deb887;">\:</span>1d.2/driver/unbind
</pre>
</div>

<p>
执行后/sys/bus/pci/devices/0000\:00\:1d.7/下的driver目录被删除
</p>

<p>
<span class="timestamp-wrapper"><span class="timestamp">[2019-09-15 Sun 22:39] </span></span> group5下面的4个usb controller全部都要删除掉
</p></li>

<li><p>
将设备地vendorid和deviceid绑定到new_id
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #B0BED8;"># </span><span style="color: #B0BED8;">usb ehci&#25511;&#21046;&#22120;</span>
<span style="color: #f08080;">echo</span> <span style="color: #deb887;">"8086 293a"</span> &gt;/sys/bus/pci/drivers/vfio-pci/new_id

<span style="color: #B0BED8;"># </span><span style="color: #B0BED8;">17.0</span>
<span style="color: #f08080;">echo</span> <span style="color: #deb887;">"8086 2934"</span> &gt;/sys/bus/pci/drivers/vfio-pci/new_id
<span style="color: #B0BED8;"># </span><span style="color: #B0BED8;">17.1</span>
<span style="color: #f08080;">echo</span> <span style="color: #deb887;">"8086 2935"</span> &gt;/sys/bus/pci/drivers/vfio-pci/new_id
<span style="color: #B0BED8;"># </span><span style="color: #B0BED8;">17.2</span>
<span style="color: #f08080;">echo</span> <span style="color: #deb887;">"8086 2936"</span> &gt;/sys/bus/pci/drivers/vfio-pci/new_id
</pre>
</div></li>

<li><p>
检测iommu_group是否绑定成功，会发现 <code>/dev/vfio</code> 下多了1(intel 82576LM千兆网卡)和5(usb controller)2个组号
</p>
<div class="org-src-container">
<pre class="src src-sh">[root@E6400 /dev/vfio] <span style="color: #B0BED8;">#</span><span style="color: #B0BED8;">ls /dev/vfio</span>
1  5 vfio
</pre>
</div></li>
</ol>

<p>
查看网卡和usb驱动是否为vfio-pci
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #B0BED8;"># </span><span style="color: #B0BED8;">&#26597;&#30475;pci&#20855;&#20307;&#26576;&#20010;bdf&#30340;&#20449;&#24687; [2019-09-15 &#21608;&#26085; 22:41:29]</span>
albert@E6400:~$ lspci -nnvv -s 00:1d.7
00:1d.7 USB controller [0c03]: Intel Corporation 82801I (ICH9 Family) USB2 EHCI Controller <span style="color: #B0BED8;">#</span><span style="color: #B0BED8;">1 [8086:293a] (rev 03) (prog-if 20 [EHCI])</span>
        Subsystem: Dell 82801I (ICH9 Family) USB2 EHCI Controller [1028:0233]
        Control: I/O- Mem+ BusMaster+ SpecCycle- MemWINV- VGASnoop- ParErr- Stepping- SERR+ FastB2B- DisINTx-
        Status: Cap+ 66MHz- UDF- FastB2B+ ParErr- <span style="color: #4eee94;">DEVSEL</span>=medium &gt;TAbort- &lt;TAbort- &lt;MAbort- &gt;SERR- &lt;PERR- INTx-
        Latency: 0
        Interrupt: pin A routed to IRQ 20
        Region 0: Memory at fed1c000 (32-bit, non-prefetchable) [<span style="color: #4eee94;">size</span>=1K]
        Capabilities: &lt;access denied&gt;
        Kernel driver<span style="color: #00bfff;"> in</span> use: vfio-pci
</pre>
</div>


<h3>nic passthrough</h3>

<ol>
<li><p>
确认IOMMU开启，就是BIOS与IOMMU相关选项打开（Intel VT-d或者AMD IOV）
</p>
<div class="org-src-container">
<pre class="src src-sh">[albert@E6400 /home/albert]
$<span style="color: #4eee94;">dmesg</span>|grep IOMM
[    0.091598] DMAR: IOMMU enabled
[    0.581651] DMAR: Disabling IOMMU for graphics on this chipset
</pre>
</div></li>

<li><p>
查看kvm内核模块是否已加载
</p>
<div class="org-src-container">
<pre class="src src-sh">root@E6400:~# lsmod|grep kvm
kvm_intel             212992  3
kvm                   598016  1 kvm_intel
irqbypass              16384  5 kvm
</pre>
</div></li>

<li><p>
确认Passthrough的设备
</p>

<p>
使用 <code>lspci -nn</code> 列出所有PCI设备和地址，记录下intel 82567LM ids为 [8086:10f5]
</p>

<div class="org-src-container">
<pre class="src src-sh">root@E6400:~# lspci -nn|grep Eth
00:19.0 Ethernet controller [0200]: Intel Corporation 82567LM Gigabit Network Connection [8086:10f5] (rev 03)

root@E6400:~# find /sys/kernel/iommu_groups/ -type l|grep 19
/sys/kernel/iommu_groups/1/devices/0000:00:19.0
</pre>
</div>

<p>
查看这两个设备属于的IOMMU组，如果没有显示任何内容，要确认BIOS中相应Intel VT-d打开与否。查找之前记录的网卡id，属于group1。如果在该组中化存在其他设备需要为kernel添加ACS Patch，相应的方法参见链接。如果只有一个组，则进行下一步。
</p>
<div class="org-src-container">
<pre class="src src-sh">root@E6400:~# find /sys/kernel/iommu_groups/ -type l
/sys/kernel/iommu_groups/7/devices/0000:00:1f.2
/sys/kernel/iommu_groups/7/devices/0000:00:1f.0
/sys/kernel/iommu_groups/7/devices/0000:00:1f.3
/sys/kernel/iommu_groups/5/devices/0000:00:1d.1 ---&gt; 4&#20010;&#37117;&#35201;unbind?
/sys/kernel/iommu_groups/5/devices/0000:00:1d.2
/sys/kernel/iommu_groups/5/devices/0000:00:1d.0
/sys/kernel/iommu_groups/5/devices/0000:00:1d.7 ---&gt; usb2.0 &#24038;&#19978;&#65311;
/sys/kernel/iommu_groups/3/devices/0000:00:1b.0
/sys/kernel/iommu_groups/1/devices/0000:00:19.0 ---&gt; intel 82567LM
/sys/kernel/iommu_groups/6/devices/0000:03:01.1
/sys/kernel/iommu_groups/6/devices/0000:00:1e.0
/sys/kernel/iommu_groups/6/devices/0000:03:01.2
/sys/kernel/iommu_groups/6/devices/0000:03:01.0
/sys/kernel/iommu_groups/4/devices/0000:0c:00.0
/sys/kernel/iommu_groups/4/devices/0000:00:1c.0
/sys/kernel/iommu_groups/4/devices/0000:00:1c.3
/sys/kernel/iommu_groups/4/devices/0000:00:1c.1
/sys/kernel/iommu_groups/4/devices/0000:00:1c.2
/sys/kernel/iommu_groups/2/devices/0000:00:1a.1
/sys/kernel/iommu_groups/2/devices/0000:00:1a.2
/sys/kernel/iommu_groups/2/devices/0000:00:1a.0
/sys/kernel/iommu_groups/2/devices/0000:00:1a.7
/sys/kernel/iommu_groups/0/devices/0000:00:00.0
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #f08080;">echo</span> <span style="color: #deb887;">"options vfio_iommu_type1 allow_unsafe_interrupts=1"</span> &gt; /etc/modprobe.d/vfio_iommu_type1.conf

<span style="color: #f08080;">echo</span> <span style="color: #deb887;">"options vfio-pci ids=10f5:8086"</span> &gt; /etc/modprobe.d/vfio.conf
<span style="color: #f08080;">echo</span> <span style="color: #deb887;">"options vfio_iommu_type1 allow_unsafe_interrupts=1"</span> &gt; /etc/modprobe.d/iommu_unsafe_interrupts.conf
<span style="color: #f08080;">echo</span> <span style="color: #deb887;">"options kvm ignore_msrs=1"</span> &gt; /etc/modprobe.d/kvm.conf
</pre>
</div></li>
</ol>

<p>
<span class="timestamp-wrapper"><span class="timestamp">[2019-08-18 Sun 20:33]</span></span>
</p>
<div class="org-src-container">
<pre class="src src-sh">[root@E6400 /root]
<span style="color: #B0BED8;">#</span><span style="color: #B0BED8;">virsh start openwrt</span>
error: Failed to start domain openwrt
error: internal error: process exited while connecting to monitor: 2019-08-18T12:33:10.046528Z qemu-system-x86_64: -device vfio-pci,<span style="color: #4eee94;">host</span>=00:19.0,<span style="color: #4eee94;">id</span>=hostdev0,<span style="color: #4eee94;">bus</span>=pci.0,<span style="color: #4eee94;">addr</span>=0x3: vfio error: 0000:00:19.0: failed to setup container for group 1: failed to set iommu for container: Operation not permitted
</pre>
</div>

<p>
<span class="timestamp-wrapper"><span class="timestamp">[2019-08-18 Sun 22:52] </span></span> 做个记号，virt中网卡pass through的配置，使用vfio。
</p>
<pre class="example" id="org68ee2bc">
&lt;hostdev mode='subsystem' type='pci' managed='yes'&gt;
  &lt;driver name='vfio'/&gt;
  &lt;source&gt;
    &lt;address domain='0x0000' bus='0x00' slot='0x19' function='0x0'/&gt;
  &lt;/source&gt;
  &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x04' function='0x0'/&gt;
&lt;/hostdev&gt;
</pre>

<p>
<span class="timestamp-wrapper"><span class="timestamp">[2020-08-15 Sat 22:57] </span></span> T430
</p>
<pre class="example" id="orgf4d7019">
&lt;hostdev mode='subsystem' type='pci' managed='yes'&gt;
  &lt;driver name='vfio'/&gt;
  &lt;source&gt;
    &lt;address domain='0x0000' bus='0x00' slot='0x19' function='0x0'/&gt;
  &lt;/source&gt;
  &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x04' function='0x0'/&gt;
&lt;/hostdev&gt;
</pre>


<h3>定位cpu高的问题 - 都是和各种timer有关 <span class="timestamp-wrapper"><span class="timestamp">[2019-09-17 Tue 14:43]</span></span></h3>

<p>
top时看见没有压力的情况下，宿主机的cpu就到15%。
</p>

<div class="org-src-container">
<pre class="src src-sh">perf top -p pid

<span style="color: #B0BED8;"># </span><span style="color: #B0BED8;">&#21457;&#29616; read_hpet &#21344;&#24471;&#26368;&#39640;&#65292;&#19981;&#27491;&#24120;</span>
</pre>
</div>

<p>
删除了usb tablet，删除了usb设备，重新把ich9的ehci加上去就ok了。
</p>


<h4>&lt;timer name='hpet' present='yes'/&gt; - 改了以后到2.3%了 <span class="timestamp-wrapper"><span class="timestamp">[2019-09-17 Tue 21:25]</span></span></h4>

<p>
看看qemu的cpu还是不是有4%左右
</p>

<p>
<a href="https://docs.fedoraproject.org/en-US/Fedora_Draft_Documentation/0.1/html/Virtualization_Deployment_and_Administration_Guide/sect-Virtualization-Tips_and_tricks-Libvirt_Managed_Timers.html">https://docs.fedoraproject.org/en-US/Fedora_Draft_Documentation/0.1/html/Virtualization_Deployment_and_Administration_Guide/sect-Virtualization-Tips_and_tricks-Libvirt_Managed_Timers.html</a>
</p>

<p>
参考了这个 <a href="https://askubuntu.com/questions/1033985/kvm-high-host-cpu-load-after-upgrading-vm-to-windows-10-1803">https://askubuntu.com/questions/1033985/kvm-high-host-cpu-load-after-upgrading-vm-to-windows-10-1803</a> 
</p>

<p>
<a href="https://forum.proxmox.com/threads/high-cpu-load-for-windows-10-guests-when-idle.44531/">https://forum.proxmox.com/threads/high-cpu-load-for-windows-10-guests-when-idle.44531/</a>
</p>

<p>
<a href="https://serverfault.com/questions/955439/why-windows-10-virtual-machine-show-high-cpu-load-on-kvm-hyprvisor">https://serverfault.com/questions/955439/why-windows-10-virtual-machine-show-high-cpu-load-on-kvm-hyprvisor</a>
</p>


<h4>&lt;timer name='pit' tickpolicy='delay'/&gt; <span class="timestamp-wrapper"><span class="timestamp">[2019-09-17 Tue 21:34]</span></span></h4>

<p>
tickpolicy改为 <b>discard</b> 。
</p>

<p>
<a href="https://unix.stackexchange.com/questions/64297/host-cpu-does-not-scale-frequency-when-kvm-guest-needs-it">https://unix.stackexchange.com/questions/64297/host-cpu-does-not-scale-frequency-when-kvm-guest-needs-it</a>
</p>

<p>
<a href="https://docs.fedoraproject.org/en-US/Fedora_Draft_Documentation/0.1/html/Virtualization_Deployment_and_Administration_Guide/sect-Virtualization-Tips_and_tricks-Libvirt_Managed_Timers.html">https://docs.fedoraproject.org/en-US/Fedora_Draft_Documentation/0.1/html/Virtualization_Deployment_and_Administration_Guide/sect-Virtualization-Tips_and_tricks-Libvirt_Managed_Timers.html</a>
</p>


<h4>增加 synic和stimer - cpu &#x2014;&gt; 1.5%以下了 <span class="timestamp-wrapper"><span class="timestamp">[2019-09-18 Wed 01:05]</span></span></h4>

<p>
<span class="timestamp-wrapper"><span class="timestamp">[2019-09-18 Wed 01:24] </span></span> 不知道为什么配置了以后，硬盘找不到了，启动的时候可能是时钟相关的 hv_ 模块报错了，但是vnc太快了看不见
</p>

<p>
<a href="https://libvirt.org/formatdomain.html">https://libvirt.org/formatdomain.html</a>
</p>
<pre class="example" id="org313aed5">
  &lt;features&gt;
    &lt;acpi/&gt;
    &lt;apic/&gt;
    &lt;hyperv&gt;
      &lt;synic state='on'/&gt;
      &lt;stimer state='on'&gt;
       &lt;direct state='on'/&gt;
      &lt;/stimer&gt;
    &lt;/hyperv&gt;
  &lt;/features&gt;
  
synic	Enable Synthetic Interrupt Controller (SynIC)	on, off	1.3.3 (QEMU 2.6)
stimer	Enable SynIC timers, optionally with Direct Mode support
</pre>

<p>
好像和 kvm:kvm_hv_timer_state event有关
</p>


<h4>65,201      kvm:kvm_write_tsc_offset <span class="timestamp-wrapper"><span class="timestamp">[2019-09-18 Wed 01:19]</span></span></h4>

<p>
里面有tsc相关内容，不调整了，tsc比较重要 <a href="https://docs.fedoraproject.org/en-US/Fedora_Draft_Documentation/0.1/html/Virtualization_Deployment_and_Administration_Guide/sect-Virtualization-Tips_and_tricks-Libvirt_Managed_Timers.html">https://docs.fedoraproject.org/en-US/Fedora_Draft_Documentation/0.1/html/Virtualization_Deployment_and_Administration_Guide/sect-Virtualization-Tips_and_tricks-Libvirt_Managed_Timers.html</a> 
</p>


<h2>dsm6.2 <span class="timestamp-wrapper"><span class="timestamp">[2019-09-16 Mon 16:35]</span></span></h2>

<p>
dsm6.2是各种问题，搞不定。
</p>

<h3>修改img - 非LVM分区挂载方法</h3>

<p>
调整img中的启动选项的时间，timeout太快了，都来不及选。
</p>

<div class="org-src-container">
<pre class="src src-sh">albert@E6400:~/dsm/dsm6.2$ fdisk -ul synoboot-ds3617_6.2-1.02b-uefi.img
Units: sectors of 1 * <span style="color: #4eee94;">512</span> = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disklabel type: gpt
Disk identifier: B3CAAA25-3CA1-48FA-A5B6-105ADDE4793F

Device                              Start    End Sectors Size Type
synoboot-ds3617_6.2-1.02b-uefi.img1  2048  32767   30720  15M EFI System
synoboot-ds3617_6.2-1.02b-uefi.img2 32768  94207   61440  30M Linux filesystem
synoboot-ds3617_6.2-1.02b-uefi.img3 94208 102366    8159   4M BIOS boot
</pre>
</div>

<p>
可以看见linux的文件系统是从第2048块开始的，所以挂载的时候应该从这个地方开始挂载。
</p>

<p>
由这条信息可以的出，扇区大小为512。
</p>

<pre class="example" id="orge830530">
Units = sectors of 1 * 512 = 512 bytes
</pre>

<p>
所以我们需要从512*2048出开始挂载，计算以字节为单位的偏移量。
</p>
<pre class="example" id="org8052e09">
2048 * 512 = 1048576
</pre>

<p>
修改群晖的mac和sn，mount 第一个分区
</p>
<div class="org-src-container">
<pre class="src src-sh">Device                                 Start    End Sectors Size Type
synoboot-ds3617xs-dsm617-20200824.img1  2048  32767   30720  15M EFI System
synoboot-ds3617xs-dsm617-20200824.img2 32768  94207   61440  30M Linux filesystem
synoboot-ds3617xs-dsm617-20200824.img3 94208 102366    8159   4M BIOS boot

mount -o loop,<span style="color: #4eee94;">offset</span>=1048576 /home/albert/dsm/dsm6.1/synoboot-ds3617xs-dsm617-20200824.img /mnt/dsm6.1

<span style="color: #B0BED8;"># </span><span style="color: #B0BED8;">192.168.0.235</span>
<span style="color: #f08080;">set</span> <span style="color: #4eee94;">sn</span>=A8ODN02468
<span style="color: #f08080;">set</span> <span style="color: #4eee94;">mac1</span>=0011322CA603

<span style="color: #B0BED8;"># </span><span style="color: #B0BED8;">[2020-09-01 &#21608;&#20108; 11:01:48] https://hlynford.com/124.html </span>
<span style="color: #f08080;">set</span> <span style="color: #4eee94;">sn</span>=1230ODN515525
<span style="color: #f08080;">set</span> <span style="color: #4eee94;">mac1</span>=001132F44E18
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">mount -o loop,<span style="color: #4eee94;">offset</span>=1048576 synoboot-ds3617_6.2-1.02b-uefi.img /mnt/dsm6.2

<span style="color: #B0BED8;"># </span><span style="color: #B0BED8;">&#33756;&#21333;&#36873;&#39033;&#25913;&#20026;20s</span>
<span style="color: #f08080;">cd</span> /mnt/dsm6.2
vim grub/grub.cfg
<span style="color: #f08080;">set</span> <span style="color: #4eee94;">timeout</span>=<span style="color: #deb887;">'20'</span>

mount -o loop,<span style="color: #4eee94;">offset</span>=1048576 synoboot-ds3617_6.2-1.02b-uefi.img /mnt/dsm6.2
</pre>
</div>

<p>
<span class="timestamp-wrapper"><span class="timestamp">[2020-08-24 Mon 14:34] </span></span> 看看ds3617的6.1.7的extra.lzma
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #B0BED8;">#</span><span style="color: #B0BED8;">mount -o loop,offset=16777216 synoboot-ds3617xs-dsm617.img /mnt/dsm6.1</span>

mount -o loop,<span style="color: #4eee94;">offset</span>=16777216 /home/albert/dsm/dsm6.1/synoboot-ds3617xs-dsm617-20200824.img /mnt/dsm6.1

<span style="color: #B0BED8;"># </span><span style="color: #B0BED8;">[2020-08-24 &#21608;&#19968; 15:26:13] &#29992;&#36825;&#20010;&#37324;&#38754;&#30340;virtio&#30340;&#39537;&#21160;&#26159;&#21487;&#20197;&#30340;&#65292;&#20294;&#26159;&#27809;&#26377;virtio-scsi&#30340;&#39537;&#21160;&#65292;&#25105;&#33258;&#24049;&#21435;&#24180;&#32534;&#35793;&#30340;&#21551;&#21160;&#23601;kernel panic&#12290;</span>
<span style="color: #B0BED8;">#</span><span style="color: #B0BED8;">mount -o loop,offset=16777216 /home/albert/dsm/dsm6.1/boot_ds3615xs_15132_kvm.img /mnt/dsm6.1</span>

[2020-08-24 &#21608;&#19968; 18:02:56]
<span style="color: #B0BED8;">#</span><span style="color: #B0BED8;">mount -o loop,offset=22020096 /home/albert/dsm/dsm6.1/DS3617xs_DSM6.1_Broadwell.img /mnt/dsm6.1</span>

cp /mnt/dsm6.1/extra.lzma /tmp/ds3617
<span style="color: #f08080;">cd</span> /tmp/ds3617
<span style="color: #B0BED8;"># </span><span style="color: #B0BED8;">&#35299;&#21387;</span>
lzma -d extra.lzma
cpio -idv &lt; extra
rm extra

<span style="color: #B0BED8;"># </span><span style="color: #B0BED8;">&#25171;&#21253;</span>
<span style="color: #f08080;">cd</span> /tmp/ds3617
(find . -name modprobe &amp;&amp; find . <span style="color: #deb887;">\!</span> -name modprobe) | cpio --owner root:root -oH newc | lzma -8 &gt; ../extra.lzma
cp /tmp/extra.lzma /mnt/dsm6.1 &amp;&amp; ls -ltr /mnt/dsm6.1
<span style="color: #B0BED8;"># </span><span style="color: #B0BED8;">cd /mnt/dsm6.1</span>
umount /mnt/dsm6.1

</pre>
</div>

<pre class="example" id="org5e68547">
EXTRA_MODULES="mii mdio libphy atl1 atl1e atl1c alx uio ipg jme skge sky2 ptp_pch pch_gbe qla3xxx qlcnic qlge netxen_nic sfc e1000 pcnet32 vmxnet3 bnx2 li
bcrc32c bnx2x cnic e1000e igb ixgbe r8101 r8168 r8169 tg3 usbnet ax88179_178a button evdev ohci-hcd virtio virtio_ring virtio_pci virtio_blk virtio_net"
DISK_MODULES="BusLogic vmw_pvscsi megaraid_mm megaraid_mbox megaraid scsi_transport_spi mptbase mptscsih mptspi mptsas mptctl ata_piix megaraid_sas mpt2sa
s mpt3sas virtio virtio_ring virtio_pci virtio_blk"
EXTRA_FIRMWARES="bnx2/bnx2-rv2p-09ax-6.0.17.fw bnx2/bnx2-rv2p-09-6.0.17.fw bnx2/bnx2-rv2p-06-6.0.15.fw tigon/tg3_tso5.bin tigon/tg3_tso.bin tigon/tg3.bin"
</pre>

<p>
<span class="timestamp-wrapper"><span class="timestamp">[2020-08-25 Tue 11:29] </span></span> 全部重新编译
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #f08080;">cd</span> /home/albert/dsm6.1/virtio-20200825
cp -p /home/albert/dsm6.1/linux/drivers/block/virtio_blk.ko .
cp -p /home/albert/dsm6.1/linux/drivers/net/virtio_net.ko .
cp -p /home/albert/dsm6.1/linux/drivers/virtio/virtio.ko .
cp -p /home/albert/dsm6.1/linux/drivers/virtio/virtio_pci.ko .
cp -p /home/albert/dsm6.1/linux/drivers/virtio/virtio_ring.ko .
cp -p /home/albert/dsm6.1/linux/drivers/scsi/virtio_scsi.ko .
scp -rp /home/albert/dsm6.1/virtio-20200825 192.168.0.43:~/dsm/dsm6.1/
<span style="color: #f08080;">cd</span> /home/albert/dsm6.1/linux

cp -p /home/albert/dsm6.1/linux/drivers/virtio/virtio_balloon.ko .
cp -p /home/albert/dsm6.1/linux/drivers/virtio/virtio_mmio.ko .
<span style="color: #B0BED8;">#</span><span style="color: #B0BED8;">cp -p /home/albert/dsm6.1/linux/drivers/ata/ahci_platform.ko .</span>
<span style="color: #B0BED8;">#</span><span style="color: #B0BED8;">cp -p /home/albert/dsm6.1/linux/drivers/ata/libata.ko .</span>
<span style="color: #B0BED8;">#</span><span style="color: #B0BED8;">cp -p /home/albert/dsm6.1/linux/drivers/ata/libahci.ko .</span>
<span style="color: #B0BED8;">#</span><span style="color: #B0BED8;">cp -p /home/albert/dsm6.1/linux/drivers/scsi/scsi_transport_spi.ko .</span>

38943298   64 -rw-rw-r--   1 albert   albert      61720 Aug 25 13:53 ./drivers/ata/ahci.ko

./drivers/ata/libahci.ko
</pre>
</div>

<p>
<span class="timestamp-wrapper"><span class="timestamp">[2020-08-24 Mon 16:45]</span></span>
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #B0BED8;"># </span><span style="color: #B0BED8;">[2020-08-24 &#21608;&#19968; 16:46:35] dsm5.2&#21487;&#20197;&#26597;&#30475;&#65292;&#23601;&#26159;&#21629;&#20196;&#26377;&#28857;&#24930;</span>
lspci -kQ

00:06.0 Mass storage controller [0100]: Red Hat, Inc. Virtio SCSI
        Subsystem: Red Hat, Inc. Device 0008
        Kernel driver<span style="color: #00bfff;"> in</span> use: virtio-pci
00:07.0 SATA controller: Intel Corporation 82801IR/IO/IH (ICH9R/DO/DH) 6 port SATA Controller [AHCI mode] (rev 02)
        Subsystem: Red Hat, Inc. QEMU Virtual Machine
        Kernel driver<span style="color: #00bfff;"> in</span> use: ahci
</pre>
</div>

<h3><span class="timestamp-wrapper"><span class="timestamp">[2020-08-15 Sat 23:56]</span></span></h3>

<ul>
<li><p>
改为q35芯片组
</p>

<p>
原来的：
&lt;os&gt;
  &lt;type arch='x86_64' machine='pc-i440fx-bionic'&gt;hvm&lt;/type&gt;
  &lt;bootmenu enable='yes'/&gt;
&lt;/os&gt;
</p></li>
</ul>

<h2>dsm6.1 <span class="timestamp-wrapper"><span class="timestamp">[2019-09-25 Wed 16:22]</span></span></h2>

<p>
从这里下载 <a href="http://down.nas2x.com/synology/dsm/6.1/6.1.7/ds3617xs/">http://down.nas2x.com/synology/dsm/6.1/6.1.7/ds3617xs/</a>
</p>

<p>
dsm 6.1.7是ok的。cpu指定broadwell，可能性能不会太好。
</p>

<p>
这个版本的问题是没有virtio-scsi的驱动，总是不认盘。
</p>

<h3>read_hpet导致cpu高问题</h3>

<p>
原来的配置
</p>
<div class="org-src-container">
<pre class="src src-sh">&lt;clock <span style="color: #4eee94;">offset</span>=<span style="color: #deb887;">'utc'</span>&gt;
  &lt;timer <span style="color: #4eee94;">name</span>=<span style="color: #deb887;">'rtc'</span> <span style="color: #4eee94;">tickpolicy</span>=<span style="color: #deb887;">'catchup'</span>/&gt;
  &lt;timer <span style="color: #4eee94;">name</span>=<span style="color: #deb887;">'pit'</span> <span style="color: #4eee94;">tickpolicy</span>=<span style="color: #deb887;">'discard'</span>/&gt;
  &lt;timer <span style="color: #4eee94;">name</span>=<span style="color: #deb887;">'hpet'</span> <span style="color: #4eee94;">present</span>=<span style="color: #deb887;">'no'</span>/&gt;
&lt;/clock&gt;
</pre>
</div>

<h3>virtio和scsi都不认盘</h3>

<pre class="example" id="orgd8740c7">
&lt;source file='/home/albert/dsm/dsm6.1/DS3617xs_DSM6.1_Broadwell.img'/&gt;
</pre>

<p>
用virtio后，盘是vd开头的，dsm只认sd开头的。所以dsm不认盘，没法用virtio。只能把sata控制器pass through，但是dsm中要有sata控制器的驱动。
</p>
<div class="org-src-container">
<pre class="src src-sh">[   15.907316] md: Autodetecting RAID arrays.
[   15.907332] This is not a kind of scsi disk 252
[   15.908231] md: deny vda1.
[   15.908233] md: export_rdev(vda1)
[   15.908245] This is not a kind of scsi disk 252
[   15.908557] md: deny vda2.
[   15.908559] md: export_rdev(vda2)
[   15.908565] This is not a kind of scsi disk 252
[   15.908654] md: invalid raid superblock magic on vda3
[   15.910197] md: vda3 does not have a valid v0.90 superblock, not importing!
[   15.910201] md: Scanned 3 and added 0 devices.
[   15.910202] md: autorun ...
[   15.910203] md: ... autorun DONE.
[   18.800910] sd 0:0:0:0: Attached scsi generic sg0 type 0
</pre>
</div>

<h2>DS3617xs_DSM6.1_Broadwell.img <span class="timestamp-wrapper"><span class="timestamp">[2019-09-27 Fri 11:20]</span></span></h2>

<p>
用virtio-scsi就报错，core，不识别scsi_dispatch_cmd。为什么呢？
</p>

<p>
用virtio就不认盘。
</p>

<ul>
<li>ide
认盘，但是性能不好。</li>

<li>sata <span class="timestamp-wrapper"><span class="timestamp">[2019-09-27 Fri 14:03]</span></span>
认盘，但是性能不用virtio好</li>

<li>scsi <span class="timestamp-wrapper"><span class="timestamp">[2019-09-27 Fri 14:06]</span></span>
dmesg直接就看不见有这个盘的log。</li>

<li>virtio
不认盘，dsm就是要把盘认成scsi，但是却不是scsi的，本来用virtio以后就不是scsi的，如何才能让dsm把vda认为不是scsi的呢?
<span class="timestamp-wrapper"><span class="timestamp">[2019-09-27 Fri 16:58] </span></span> 搞不定</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">qemu-system-x86_64 -enable-kvm -name <span style="color: #4eee94;">guest</span>=dsm6.2,debug-threads=on -S -machine pc-i440fx-bionic,<span style="color: #4eee94;">accel</span>=kvm,<span style="color: #4eee94;">usb</span>=off,dump-guest-core=off -cpu Broadwell,hv_synic,hv_stimer -m 2000 -realtime <span style="color: #4eee94;">mlock</span>=off -smp 2,<span style="color: #4eee94;">sockets</span>=2,<span style="color: #4eee94;">cores</span>=1,<span style="color: #4eee94;">threads</span>=1 -uuid 7b9ee21c-502b-4661-bf67-1f139e2bc246 -no-user-config -nodefaults -rtc <span style="color: #4eee94;">base</span>=localtime,<span style="color: #4eee94;">clock</span>=vm,<span style="color: #4eee94;">driftfix</span>=slew -global kvm-pit.lost_tick_policy=discard -no-shutdown -global PIIX4_PM.disable_s3=1 -global PIIX4_PM.disable_s4=1 -boot <span style="color: #4eee94;">strict</span>=on -device ich9-usb-ehci1,<span style="color: #4eee94;">id</span>=usb,<span style="color: #4eee94;">bus</span>=pci.0,<span style="color: #4eee94;">addr</span>=0x4.0x7 -device ich9-usb-uhci1,<span style="color: #4eee94;">masterbus</span>=usb.0,<span style="color: #4eee94;">firstport</span>=0,<span style="color: #4eee94;">bus</span>=pci.0,<span style="color: #4eee94;">multifunction</span>=on,<span style="color: #4eee94;">addr</span>=0x4 -device ich9-usb-uhci2,<span style="color: #4eee94;">masterbus</span>=usb.0,<span style="color: #4eee94;">firstport</span>=2,<span style="color: #4eee94;">bus</span>=pci.0,<span style="color: #4eee94;">addr</span>=0x4.0x1 -device ich9-usb-uhci3,<span style="color: #4eee94;">masterbus</span>=usb.0,<span style="color: #4eee94;">firstport</span>=4,<span style="color: #4eee94;">bus</span>=pci.0,<span style="color: #4eee94;">addr</span>=0x4.0x2 -device lsi,<span style="color: #4eee94;">id</span>=scsi0,<span style="color: #4eee94;">bus</span>=pci.0,<span style="color: #4eee94;">addr</span>=0x6 -device ahci,<span style="color: #4eee94;">id</span>=sata0,<span style="color: #4eee94;">bus</span>=pci.0,<span style="color: #4eee94;">addr</span>=0x7 -drive <span style="color: #4eee94;">file</span>=/home/albert/dsm/dsm6.1/DS3617xs_DSM6.1_Broadwell.img,<span style="color: #4eee94;">format</span>=raw,<span style="color: #4eee94;">if</span>=none,<span style="color: #4eee94;">id</span>=drive-ide0-0-0 -device ide-hd,<span style="color: #4eee94;">bus</span>=ide.0,<span style="color: #4eee94;">unit</span>=0,<span style="color: #4eee94;">drive</span>=drive-ide0-0-0,<span style="color: #4eee94;">id</span>=ide0-0-0,<span style="color: #4eee94;">bootindex</span>=1 -drive <span style="color: #4eee94;">file</span>=/var/lib/libvirt/images/dsm-scsi.img,<span style="color: #4eee94;">format</span>=raw,<span style="color: #4eee94;">if</span>=none,<span style="color: #4eee94;">id</span>=drive-virtio-disk0,<span style="color: #4eee94;">cache</span>=none,<span style="color: #4eee94;">aio</span>=native -device virtio-blk-pci,<span style="color: #4eee94;">scsi</span>=on,<span style="color: #4eee94;">bus</span>=pci.0,<span style="color: #4eee94;">addr</span>=0x8,<span style="color: #4eee94;">drive</span>=drive-virtio-disk0,<span style="color: #4eee94;">id</span>=virtio-disk0 -chardev pty,<span style="color: #4eee94;">id</span>=charserial0 -device isa-serial,<span style="color: #4eee94;">chardev</span>=charserial0,<span style="color: #4eee94;">id</span>=serial0 -device usb-tablet,<span style="color: #4eee94;">id</span>=input0,<span style="color: #4eee94;">bus</span>=usb.0,<span style="color: #4eee94;">port</span>=1 -vnc 0.0.0.0:14109 -device VGA,<span style="color: #4eee94;">id</span>=video0,<span style="color: #4eee94;">vgamem_mb</span>=16,<span style="color: #4eee94;">bus</span>=pci.0,<span style="color: #4eee94;">addr</span>=0x2 -device vfio-pci,<span style="color: #4eee94;">host</span>=00:19.0,<span style="color: #4eee94;">id</span>=hostdev0,<span style="color: #4eee94;">bus</span>=pci.0,<span style="color: #4eee94;">addr</span>=0x3 -device virtio-balloon-pci,<span style="color: #4eee94;">id</span>=balloon0,<span style="color: #4eee94;">bus</span>=pci.0,<span style="color: #4eee94;">addr</span>=0x5 -msg <span style="color: #4eee94;">timestamp</span>=on

2019-09-27T07:02:12.535671Z qemu-system-x86_64: -device virtio-blk-pci,<span style="color: #4eee94;">scsi</span>=on,<span style="color: #4eee94;">bus</span>=pci.0,<span style="color: #4eee94;">addr</span>=0x8,<span style="color: #4eee94;">drive</span>=drive-virtio-disk0,<span style="color: #4eee94;">id</span>=virtio-disk0: Please set <span style="color: #4eee94;">scsi</span>=off for virtio-blk devices<span style="color: #00bfff;"> in</span> order to use virtio 1.0
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">fdisk /dev/vda
d <span style="color: #B0BED8;"># </span><span style="color: #B0BED8;">&#21024;&#38500;&#20998;&#21306;</span>
n <span style="color: #B0BED8;"># </span><span style="color: #B0BED8;">create partition</span>
p <span style="color: #B0BED8;"># </span><span style="color: #B0BED8;">primary partition</span>
+4000M <span style="color: #B0BED8;"># </span><span style="color: #B0BED8;">&#19968;&#20010;&#20998;&#21306;4G</span>
t <span style="color: #B0BED8;"># </span><span style="color: #B0BED8;">partition tag</span>
fd <span style="color: #B0BED8;"># </span><span style="color: #B0BED8;">raid tag</span>
</pre>
</div>

<p>
用同一个盘建RAID1会提示用了同一个盘。
</p>
<div class="org-src-container">
<pre class="src src-sh">mdadm -Cv /dev/md0 -a yes -l 0 -n 2 /dev/vda{1,2}
</pre>
</div>

<p>
<span class="timestamp-wrapper"><span class="timestamp">[2019-09-27 Fri 15:34] </span></span> 手工创建RAID1，但是在安装时报格式化磁盘失败。(35)
</p>
<div class="org-src-container">
<pre class="src src-sh">DiskStation&gt; mdadm -Cv /dev/md0 -l1 -n2 /dev/vda[12]
mdadm: Note: this array has metadata at the start and
    may not be suitable as a boot device.  If you plan to
    store <span style="color: #deb887;">'/boot'</span> on this device please ensure that
    your boot-loader understands md/v1.x metadata, or use
    --metadata=0.90
mdadm: size set to 3905408K

DiskStation&gt; cat /proc/mdstat
Personalities : [linear] [raid0] [raid1] [raid10] [raid6] [raid5] [raid4] [raidF1]
md0 : active raid1 vda2[1] vda1[0]
      3905408 blocks super 1.2 [2/2] [UU]
      [==&gt;..................]  <span style="color: #4eee94;">resync</span> = 14.9% (584448/3905408) <span style="color: #4eee94;">finish</span>=0.4min <span style="color: #4eee94;">speed</span>=116889K/sec

unused devices: &lt;none&gt;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">fdisk -ul 

mount -o loop,<span style="color: #4eee94;">offset</span>=1048576 /home/albert/dsm/dsm6.1/DS3617xs_DSM6.1_Broadwell.img /mnt/dsm6.2

mount -o loop,<span style="color: #4eee94;">offset</span>=22020096 /home/albert/dsm/dsm6.1/DS3617xs_DSM6.1_Broadwell.img /mnt/dsm6.2_img2
</pre>
</div>

<p>
<span class="timestamp-wrapper"><span class="timestamp">[2019-09-27 Fri 16:31] </span></span> baidu: udev site:xpenology.com
考虑使用udev把 /dev/vda 改为 /dev/sda
</p>

<p>
<a href="http://blog.chinaunix.net/uid-31410005-id-5789856.html">http://blog.chinaunix.net/uid-31410005-id-5789856.html</a> 如何让KVM虚拟机显示sda而不是vda - 没地方改啊
</p>

<p>
<a href="https://xpenology.com/forum/topic/12470-how-to-play-around-with-hdd-mapping-with-sataportmap-and-diskidxmap/">https://xpenology.com/forum/topic/12470-how-to-play-around-with-hdd-mapping-with-sataportmap-and-diskidxmap/</a> 没有用udev改名的内容，但是又 sataportmap的解释
</p>

<p>
<a href="https://xpenology.com/forum/topic/5982-how-does-the-xpenology-bootloader-work/?tab=comments#comment-51884">https://xpenology.com/forum/topic/5982-how-does-the-xpenology-bootloader-work/?tab=comments#comment-51884</a> 说了virtio的盘符是vda的问题，但是没解决
</p>

<p>
<a href="http://www.gebi1.com/thread-292649-1-1.html">http://www.gebi1.com/thread-292649-1-1.html</a> 关于硬盘直通黑裙的问题！
</p>

<p>
<a href="https://xpenology.com/forum/topic/12866-drivers-requests-for-dsm-62/page/3/">https://xpenology.com/forum/topic/12866-drivers-requests-for-dsm-62/page/3/</a> 里面有一些如何编译内核的东西
</p>

<p>
<a href="https://github.com/SynologyOpenSource/pkgscripts-ng">https://github.com/SynologyOpenSource/pkgscripts-ng</a> 编译
</p>

<p>
<a href="https://github.com/kref/scripts/blob/master/mkramdisk">https://github.com/kref/scripts/blob/master/mkramdisk</a> 到底用哪个？
</p>

<h2>T430和ds3617xs、synoboot-ds3617xs-dsm617.img <span class="timestamp-wrapper"><span class="timestamp">[2020-08-17 Mon 00:47]</span></span></h2>

<p>
dsm 6.1.7 启动后可以通过
virsh console dsm617
查看启动的log，而且可以在没挂盘时，root免密码登录。这点很有帮助，可以确定网卡、磁盘是否正常。
</p>

<p>
ip 192.168.0.235
</p>

<p>
关闭ksmd
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #f08080;">echo</span> 2 &gt; /sys/kernel/mm/ksm/run
</pre>
</div>


<h3>安装dsm 6.1.7后报，无法安装此文件，文件可能已经损毁。（13）的问题 <span class="timestamp-wrapper"><span class="timestamp">[2020-08-17 Mon 00:49]</span></span></h3>

<p>
这个问题定位了很久，换了3615xs和3617xs的好几个boot文件。
</p>

<p>
在使用synoboot-ds3617xs-dsm617.img发现，
</p>

<p>
/var/log/messages中有报错
boot/boot_lock.c(226): failed to mount boot device /dev/synoboot2 /tmp/bootmnt site:xpenology.com
</p>

<p>
google上面的关键字后，在 <a href="https://xpenology.com/forum/topic/7387-tutorial-dsm-6x-on-proxmox/page/5/">https://xpenology.com/forum/topic/7387-tutorial-dsm-6x-on-proxmox/page/5/</a> 中发现
</p>

<pre class="example" id="orge171683">
agent: 1
args: -device 'piix3-usb-uhci,addr=0x18' -drive 'id=synoboot,file=/var/lib/vz/images/102/synoboot.img,if=none,format=raw' -device 'usb-storage,id=synoboot,drive=synoboot'
bios: seabios
</pre>

<p>
<a href="https://archive.synology.com/download/DSM/release/6.1/15047/">https://archive.synology.com/download/DSM/release/6.1/15047/</a>
</p>

<p>
image用的是usb，原来我都是用virtio等类型，思维没有转过来，在virt-manager中改为usb后，重新装系统后，居然ok了。
</p>

<p>
自己的盘只能用ide，用sata、scsi和virtio都会在黑群晖启动时报没有insert hdisk。。。ide的性能不太好。
</p>


<h3>物理黑群 <span class="timestamp-wrapper"><span class="timestamp">[2020-08-17 Mon 15:14]</span></span></h3>

<p>
<a href="https://xpenology.com/forum/topic/25833-tutorial-use-linux-to-create-bootable-xpenology-usb/">https://xpenology.com/forum/topic/25833-tutorial-use-linux-to-create-bootable-xpenology-usb/</a>
在T430上制作u盘
</p>

<div class="org-src-container">
<pre class="src src-sh">root@T430:~# lsusb
Bus 002 Device 002: ID 8087:0024 Intel Corp. Integrated Rate Matching Hub
Bus 002 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub
Bus 001 Device 005: ID 5986:02d5 Acer, Inc
Bus 001 Device 004: ID 147e:2020 Upek TouchChip Fingerprint Coprocessor (WBF advanced mode)
Bus 001 Device 003: ID 046d:c52b Logitech, Inc. Unifying Receiver
Bus 001 Device 002: ID 8087:0024 Intel Corp. Integrated Rate Matching Hub
Bus 001 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub
Bus 004 Device 001: ID 1d6b:0003 Linux Foundation 3.0 root hub
Bus 003 Device 002: ID 0ed1:6981 WinMaxGroup --&gt; 
Bus 003 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub

<span style="color: #B0BED8;"># </span><span style="color: #B0BED8;">sandisk 64G u&#30424;&#26159;&#36825;&#20010; [2020-08-17 &#21608;&#19968; 15:58:53]</span>
Bus 002 Device 009: ID 0781:5571 SanDisk Corp. Cruzer Fit

[2020-08-20 &#21608;&#22235; 12:42:20] 32g sandisk
Bus 002 Device 017: ID 0781:5567 SanDisk Corp. Cruzer Blade
</pre>
</div>

<p>
vid = 0ed1
pid = 6981
</p>

<div class="org-src-container">
<pre class="src src-sh">fdisk -l
Disk /dev/sdb: 7.5 GiB, 8075083776 bytes, 15771648 sectors
Units: sectors of 1 * <span style="color: #4eee94;">512</span> = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disklabel type: dos
Disk identifier: 0x3bc5958c

Device     Boot   Start      End  Sectors Size Id Type
/dev/sdb1  *    1142528 15771647 14629120   7G  c W95 FAT32 (LBA)

<span style="color: #B0BED8;"># </span><span style="color: #B0BED8;">&#30830;&#23450;u&#30424;&#26159;/dev/sdb [2020-08-17 &#21608;&#19968; 15:18:16]</span>

sudo dd <span style="color: #4eee94;">if</span>=/home/albert/dsm6.1.7/synoboot-ds3617xs-dsm617.img <span style="color: #4eee94;">of</span>=/dev/sdb <span style="color: #4eee94;">bs</span>=512
102400+0 records<span style="color: #00bfff;"> in</span>
102400+0 records out
52428800 bytes (52 MB, 50 MiB) copied, 17.0841 s, 3.1 MB/s

dd <span style="color: #4eee94;">if</span>=/home/albert/dsm6.1.7/synoboot-ds3617xs-dsm617.img <span style="color: #4eee94;">of</span>=/dev/sdd <span style="color: #4eee94;">bs</span>=512
dd <span style="color: #4eee94;">if</span>=/home/albert/dsm/synoboot-ds3617xs-dsm617.img <span style="color: #4eee94;">of</span>=/dev/sdc <span style="color: #4eee94;">bs</span>=512

<span style="color: #B0BED8;"># </span><span style="color: #B0BED8;">[2020-08-20 &#21608;&#22235; 12:42:57] dsm3617 dsm6.2</span>
dd <span style="color: #4eee94;">if</span>=/home/albert/dsm/dsm6.2/dsm.6.2.synoboot_ds3617xs.1.03b.img <span style="color: #4eee94;">of</span>=/dev/sdc <span style="color: #4eee94;">bs</span>=512
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #B0BED8;"># </span><span style="color: #B0BED8;">&#20877;&#30475;&#30475;</span>
fdisk -l
GPT PMBR size mismatch (102399 != 15771647) will be corrected by w(rite).
The backup GPT table is corrupt, but the primary appears OK, so that will be used.
Disk /dev/sdb: 7.5 GiB, 8075083776 bytes, 15771648 sectors
Units: sectors of 1 * <span style="color: #4eee94;">512</span> = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disklabel type: gpt
Disk identifier: C94E55EA-A4D2-4E78-9D73-46CBAE7A03EF

Device     Start    End Sectors Size Type
/dev/sdb1   2048  32767   30720  15M EFI System
/dev/sdb2  32768  94207   61440  30M Linux filesystem
/dev/sdb3  94208 102366    8159   4M BIOS boot
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">sudo mount /dev/sdb1 /mnt/usb/part1
sudo mount /dev/sdb2 /mnt/usb/part2
sudo mount /dev/sdb3 /mnt/usb/part3

mount /dev/sdc1 /mnt/usb/part1
mount /dev/sdc2 /mnt/usb/part2
mount /dev/sdc3 /mnt/usb/part3
</pre>
</div>

<p>
<span class="timestamp-wrapper"><span class="timestamp">[2020-08-20 Thu 12:48] </span></span> 最低可以到800.00
albert@E6400:~/dsm/dsm6.2$ cat /proc/cpuinfo |grep MH
cpu MHz         : 821.117
cpu MHz         : 828.002
</p>

<p>
<span class="timestamp-wrapper"><span class="timestamp">[2020-08-17 Mon 16:35] </span></span> 黑群 我们检测到硬盘5,6有错误 - 不小心点了在线安装，把u盘的img升级到最新的6.2.3版本了，所以报这个错。
</p>


<h3>dsm617 shell在vi mode中tab不是命令补齐的问题 <span class="timestamp-wrapper"><span class="timestamp">[2020-08-20 Thu 20:37]</span></span></h3>

<p>
<a href="https://stackoverflow.com/questions/2252183/tab-autocompletion-in-bash-vi-shell-mode">https://stackoverflow.com/questions/2252183/tab-autocompletion-in-bash-vi-shell-mode</a>
</p>

<div class="org-src-container">
<pre class="src src-sh">admin@dsm617:/$ bind -q complete
complete can be invoked via <span style="color: #deb887;">"\C-i"</span>, <span style="color: #deb887;">"\e\e"</span>.
admin@dsm617:/$ set -o vi
admin@dsm617:/$ bind -q complete
complete is not bound to any keys.

<span style="color: #B0BED8;"># </span><span style="color: #B0BED8;">&#35201;&#37325;&#26032;&#35774;&#32622;&#19968;&#19979;&#65292;&#20026;&#20160;&#20040;&#65311;</span>
bind <span style="color: #deb887;">'"\C-i":complete'</span>
</pre>
</div>


<h3>vmm套件 <span class="timestamp-wrapper"><span class="timestamp">[2020-08-18 Tue 15:17]</span></span></h3>



<h4>centos 7.5 yum源 <span class="timestamp-wrapper"><span class="timestamp">[2020-08-18 Tue 15:27]</span></span></h4>

<p>
更新yum源为aliyun <a href="https://www.cnblogs.com/kcxg/p/11457180.html">https://www.cnblogs.com/kcxg/p/11457180.html</a>
</p>

<p>
aliyun官方CentOS镜像 <a href="https://developer.aliyun.com/mirror/centos?spm=a2c6h.13651102.0.0.3e221b11PawzPA">https://developer.aliyun.com/mirror/centos?spm=a2c6h.13651102.0.0.3e221b11PawzPA</a>
阿里云官方镜像站 <a href="https://developer.aliyun.com/mirror/">https://developer.aliyun.com/mirror/</a>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #B0BED8;"># </span><span style="color: #B0BED8;">1. backup</span>
mv /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.bak

<span style="color: #B0BED8;"># </span><span style="color: #B0BED8;">2. &#19979;&#36733;&#26032;&#30340;CentOS-Base.repo &#21040;/etc/yum.repos.d/</span>
curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo

<span style="color: #B0BED8;"># </span><span style="color: #B0BED8;">3. &#28155;&#21152;EPEL</span>
curl -o /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo

<span style="color: #B0BED8;"># </span><span style="color: #B0BED8;">4. &#28165;&#29702;&#32531;&#23384;&#24182;&#29983;&#25104;&#26032;&#30340;&#32531;&#23384;</span>
yum clean all
yum makecache
</pre>
</div>


<h4>centos dig</h4>

<p>
<a href="https://www.cnblogs.com/wangboyu/p/11934397.html">https://www.cnblogs.com/wangboyu/p/11934397.html</a>
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #B0BED8;"># </span><span style="color: #B0BED8;">&#23433;&#35013;dig</span>
yum install bind-utils
</pre>
</div>


<h4>centos gcc开发环境</h4>

<div class="org-src-container">
<pre class="src src-sh">yum group install <span style="color: #deb887;">"Development Tools"</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">git clone https://github.com/alibaba/tsar.git
</pre>
</div>


<h4>ubuntu 20.04 server</h4>

<p>
ubuntu在启动以后，从dsm上top看qemu进程总是有10%左右的cpu，而centos 7.5就没有，奇怪啊。
</p>


<h4>vm绑定物理核 <span class="timestamp-wrapper"><span class="timestamp">[2020-08-19 Wed 16:30]</span></span></h4>

<p>
KVM虚拟机CPU绑定性能调优 <a href="https://blog.csdn.net/maoliping455mlp455/article/details/9712641">https://blog.csdn.net/maoliping455mlp455/article/details/9712641</a>
</p>
<div class="org-src-container">
<pre class="src src-sh">root@dsm617:~# virsh vcpuinfo 7
VCPU:           0
CPU:            0
State:          running
CPU time:       316.4s
CPU Affinity:   yyyy

VCPU:           1
CPU:            2
State:          running
CPU time:       347.6s
CPU Affinity:   yyyy
</pre>
</div>

<h2>Ubuntu 18.04最小安装</h2>

<p>
1.Ubuntu最小安装
</p>

<p>
2.添加ppa：
    sudo add-apt-repository ppa:webupd8team/java
    sudo apt-get update
</p>

<p>
3.卸载亚马逊链接：
    sudo apt-get remove unity-webapps-common 没有
</p>

<p>
4.卸载一些不常用的链接：
    sudo apt-get remove 
thunderbird 没有
totem 没有，只有libtotem
rhythmbox 没有
empathy 没有
brasero 
simple-scan 
gnome-mahjongg 没有
aisleriot
    sudo apt-get remove 
gnome-mines 没有
cheese transmission-common gnome-orca webbrowser-app gnome-sudoku  landscape-client-ui-install
    sudo apt-get remove onboard deja-dup
</p>

<p>
<span class="timestamp-wrapper"><span class="timestamp">[2020-08-30 Sun 17:05] </span></span> cheese-common
</p>

<p>
5.卸载LibreOffice：
    sudo apt-get remove libreoffice-common
</p>

<p>
6.卸载Firefox浏览器：
    sudo apt-get remove firefox*
</p>

<p>
7.安装Git：
    sudo apt-get install git
</p>

<p>
8.安装Vim：
    sudo apt-get install vim
</p>

<p>
9.安装Chrome浏览器：
    wget <a href="https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb">https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb</a>
    sudo dpkg -i *.deb
</p>

<p>
10.安装oracle-java-installer：
    sudo apt-get install oracle-java8-installer
</p>

<p>
11.安装idea：
    (1).下载idea
    (2).解压到/opt目录下
        sudo tar -zxvf ideaIU-2016.3.3-no-jdk.tar.gz -C /opt
    (3).进入到bin文件夹：
        cd /opt/idea-IU-163.11103.6/bin
    (4).创建快捷方式文件 idea.desktop：
        vim idea.desktop
    (5).编辑 idea.desktop 文件：
        [Desktop Entry]
        Name=IntelliJ IDEA
        Comment=IntelliJ IDEA
        Exec=/home/longsky/Application/idea-IU-163.7743.44/bin/idea.sh
        Icon=/home/longsky/Application/idea-IU-163.7743.44/bin/idea.png
        Terminal=false
        Type=Application
        Categories=Developer;
</p>

<h2>ubuntu16.04系统精简</h2>

<p>
一、更新系统
</p>

<p>
apt-get update
apt-get dist-upgrade
</p>

<p>
二、查看所有内核
</p>

<p>
sudo dpkg &#x2013;get-selections |grep linux
</p>

<p>
三、清除不用的内核
</p>

<p>
apt-get purge linux-image-extra-x.x.x-x-generic \
    linux-image-x.x.x-x-generic \
    linux-headers-x.x.x-x \
    linux-headers-x.x.x-x-generic
</p>

<p>
四、删除无用的软件
</p>

<p>
apt-get purge mdadm \
    git \
    acpid \
    vim* \
    ubuntu-cloudimage-keyring \
    ubuntu-core-launcher \
    software-properties-common \
    lxc* \
    lxd* \
    perl
</p>

<p>
apt-get autoremove
</p>

<p>
五、清理文件
</p>

<p>
apt-get clean all
</p>

<h2>KVM clock <span class="timestamp-wrapper"><span class="timestamp">[2020-09-03 Thu 11:13]</span></span></h2>

<p>
在dsm617上使用tsc，看见native_write_msr比较多，可能是和时钟有关系，考虑用kvm_clock，但是kvm clock driver在哪里呢？在kvm.ko kvm-intel.ko里面？
dsm启动时是没看见kvm和kvm-intel.ko的，是要在extra.lzma里面加上去吗？
<span class="timestamp-wrapper"><span class="timestamp">[2020-09-03 Thu 11:31] </span></span> 加了以后，在dsm617里面没看见kvm.ko
</p>

<p>
&lt;clock offset='utc'&gt;
  &lt;timer name='rtc' tickpolicy='catchup'/&gt;
  &lt;timer name='pit' tickpolicy='delay'/&gt;
  &lt;timer name='hpet' present='no'/&gt;
  &lt;timer name='tsc' present='yes'/&gt;
  &lt;timer name='kvmclock' present='yes'/&gt;
&lt;/clock&gt;
</p>

<p>
在/sys/devices/system/clocksource/clocksource0目录下；
</p>

<ul>
<li>当前所有可用的clocksource
cat /sys/devices/system/clocksource/clocksource0/available_clocksource</li>

<li>当前正在使用的clocksource。
cat /sys/devices/system/clocksource/clocksource0/current_clocksource</li>
</ul>

<p>
grep -iE 'paravirt|KVM_CLOCK' /boot/config-*
CONFIG_PARAVIRT_CLOCK=y 　　　　 #y：编译进内核
</p>


<h3>ptp(Precision Time Protocol) <span class="timestamp-wrapper"><span class="timestamp">[2020-09-03 Thu 12:05]</span></span></h3>

<p>
ptp是用来和host进行时钟同步的，现在dsm用了ntp同步，无所谓了。
</p>

<p>
<a href="https://zshisite.wordpress.com/2017/10/25/sync-your-cloud-with-ptp/">https://zshisite.wordpress.com/2017/10/25/sync-your-cloud-with-ptp/</a>
</p>

<p>
dmesg
[    0.406237] PTP clock support registered
</p>


<h2>docker</h2>



<h3>v2ray <span class="timestamp-wrapper"><span class="timestamp">[2020-09-03 Thu 10:17]</span></span></h3>

<ol>
<li>access log写到 /dev/null 吧</li>
<li>log level用默认的warning，不改为error。</li>
</ol>

<h2>cpu火焰图 <span class="timestamp-wrapper"><span class="timestamp">[2020-09-03 Thu 15:09]</span></span></h2>

<p>
<a href="https://github.com/brendangregg/FlameGraph">https://github.com/brendangregg/FlameGraph</a>
</p>

<p>
perf + 火焰图分析程序性能 <a href="https://www.cnblogs.com/happyliu/p/6142929.html">https://www.cnblogs.com/happyliu/p/6142929.html</a>
</p>

<p>
阮一峰 如何读懂火焰图？ <a href="http://www.ruanyifeng.com/blog/2017/09/flame-graph.html">http://www.ruanyifeng.com/blog/2017/09/flame-graph.html</a>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #f08080;">cd</span> /home/albert
<span style="color: #B0BED8;"># </span><span style="color: #B0BED8;">1. &#29992; perf record&#37319;&#38598;&#25968;&#25454;</span>
<span style="color: #B0BED8;"># </span><span style="color: #B0BED8;">perf record -F 99 -p 50713 -g -- sleep 60</span>
root@600g4:/home/albert# perf record -p 50713 -g -- sleep 60
[ perf record: Woken up 7 times to write data ]
[ perf record: Captured and wrote 1.951 MB perf.data (10331 samples) ]

<span style="color: #B0BED8;"># </span><span style="color: #B0BED8;">2. &#26684;&#24335;&#36716;&#25442;</span>
root@600g4:/home/albert# perf script &gt; out.perf

<span style="color: #B0BED8;"># </span><span style="color: #B0BED8;">For perf_events:</span>
root@600g4:/home/albert# FlameGraph/stackcollapse-perf.pl out.perf &gt; out.folded

<span style="color: #B0BED8;"># </span><span style="color: #B0BED8;">3. &#29983;&#25104;&#28779;&#28976;&#22270; Use flamegraph.pl to render a SVG.</span>
FlameGraph/flamegraph.pl out.folded &gt; dsm.svg
</pre>
</div>
<div class="taglist"></div></div>
<div id="postamble" class="status"></div>
</body>
</html>
